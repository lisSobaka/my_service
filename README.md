# my_service

## Проект CRM для сервисного центра по ремонту цифровой техники.

> *В настоящий момент сайт адаптирован только под десктопные браузеры, протестирован на Chrome, Opera*

### На данный момент реализован следующий функционал:
- [Авторизация в системе и регистрация нового пользователя](#register)
- [Разграничение прав доступа](#roles)
- [Создание, изменение и удаление карточки заказа](#orders)
- [Закрытие заказа](#close_order)
- [Создание, изменение и удаление карточки клиента](#clients)
- [Добавление, изменение и удаление услуг в заказе](#works)
- [Добавление и удаление платежей в заказе и на странице управления платежами](#payments)
- [История ведения заказа с возможностью оставления комментариев](#order_history)
- [Модуль автоматического учёта заработной платы сотрудников](#salary)
- [Поиск](#search)
- [Фильтр](#filter) 

### <a id="register"></a> Авторизация в системе и регистрация нового пользователя
> Не авторизованные в системе пользователи автоматически перенаправляются на страницу авторизации <br>

Для наглядности, на странице авторизации размещены кнопки авторизации под администратором (неограниченные права, доступ в админ-панель) и под мастером (права ограничены, группа ['Repairer'](#repairer)) <br>
Изначально, после регистрации, учётная запись добавляется в группу с ограниченными правами (['Repairer'](#repairer)) и неактивна. Активировать её должен администратор через админ-панель Django. Процент заработной платы устанавливается на 50%

### <a id="roles"></a> Разграничение прав доступа
Для разграничения прав доступа в системе доступны группы и персональные права для пользователей. Управление осуществляется через админ-панель Django <br>
По умолчанию доступен суперпользователь с неограниченными правами и группа 'Repairer'<br>

<a id="repairer"></a> Права члена группы 'Repairer': <br>
 - Создание, изменение и просмотр карточек заказов
 - Создание, изменение и просмотр карточек клиентов
 - Добавление, изменение и просмотр услуг в заказах
 - Добавление и просмотр сообщений в истории заказа
 - Добавление и просмотр платежей
 - Просмотр страницы начислений заработной платы

### <a id="orders"></a> Создание, изменение и удаление карточки заказа
Для создания карточки нового заказа необходимо нажать на ссылку 'Новый заказ' в верхней меню приложения. <br>
Сумма, указанная в поле 'Предоплата' автоматически добавляется в платежи после сохранения карточки заказа <br>
В поле 'Исполнитель' по умолчанию выставляется авторизованный в данный момент пользователь, опционально можно выбрать другого пользователя, зарегистрированного в системе. <br> 
В поле 'Дата готовности' по умолчанию выставляется текущая дата + 3 дня, время округляется до следующего часа относительно времени UTC. Дату время готовности можно изменить по согласованию с клиентом.

### <a id="close_order"></a> Закрытие заказа
При нажатии кнопки 'Закрыть заказ' в карточке заказа открывается форма добавления платежа на сумму всех добавленных, но ещё не оплаченных услуг в заказе.
После подтверждения закрытия заказа, в платежи добавляется соответствующая запись, статус всех услуг в карточке меняется на 'Оплачено', в ЗП исполнителя добавляются записи о каждой выполненной им услуге по формуле:

>(Стоимость - себестоимость - скидка) * количество * (процент мастера / 100)

### <a id="clients"></a> Создание, изменение и удаление карточки клиента
Карточки клиентов создаются автоматически при сохранении карточек новых заказов. Впоследствии просматривать, редактировать и удалять их можно на странице 'Клиенты' и в карточке заказа этого клиента.

### <a id="works"></a> Добавление, изменение и удаление услуг в заказе
При добавлении новой услуги указывается стоимость этой услуги (для клиента), а также её себестоимость (стоимость запчастей, используемых при её оказании для сервиса). 
Впоследствии, при подсчёте заработной платы и в отчётах по прибыли будет фигурировать чистая прибыль (стоимость минус себестоимость). <br>
Так же, опционально, можно указать скидку для клиента в рублях, указать продолжительность гарантии в днях и выбрать исполнителя, именно ему будет начислена заработная плата. <br>
Для изменения услуги впоследствии следует кликнуть по ней в карточке заказа. Для удаления - синий крестик в правой части строки и подтвердить удаление. <br>

> При удалении услуги в карточке заказа, запись о выполнении этой услуги автоматически удалится со страницы ЗП и учитываться в общей сумме не будет. <br>

### <a id="payments"></a> Добавление и удаление платежей в заказе и на странице управления платежами
Записи о добавлении платежей создаются в следующих случаях:

 - При указании предоплаты в форме создания новой карточки заказа
 - При добавлении платежа через кнопку 'Добавить платёж' либо 'Возврат предоплаты' в карточке заказа
 - При нажатии кнопки '[Закрыть заказ](#close_order)'
 - При нажатии кнопки 'Выплатить ЗП' на странице сотрудника в модуле ЗП

При удалении платежей пересчитывается статистика в верхней части страницы 'Платежи', а также предусмотрено особое поведение для платежей различных типов:

 - При удалении платежа с основанием 'Оплата заказа', все услуги, оплаченные этим платежом, вновь становятся неоплаченными, пересчитывается сумма, которую должен клиент в карточке заказа.
 - При удалении платежа с основанием 'Выплата заработной платы', все услуги, оплаченные мастеру, снова становятся неоплаченными, пересчитывается сумма в блоке ЗП
 - При удалении платежа с основанием 'Предоплата' и 'Возврат предоплаты', удаляются о получении, либо, соответственно, возврате предоплаты в соответствующем заказе, пересчитывается сумма долга клиента.

### <a id="order_history"></a> История ведения заказа с возможностью оставления комментариев

При работе с заказом есть возможность оставить комментарий или заметку для себя или другого пользователя приложения. <br>
Так же комментарии создаются автоматически в процессе ведения заказа в следующих ситуациях:

 - Создание заказа
 - Добавление или удаление услуги
 - Добавление или удаление платежа
 - Закрытие заказа

В сообщении указывается дата события, фамилия и имя инициировавшего событие пользователя

### <a id="salary"></a> Модуль автоматического учёта заработной платы сотрудников

> Процент от суммы услуги, который исполнитель будет получать в заработную плату, можно установить в панели администратора в разделе 'Пользователи'. <br>
> По умолчанию у всех пользователей он составляет 50%.

При переходе к странице детализации ЗП сотрудника, отображаются все записи о выполненных сотрудником услугах в заказах. <br>
Сумма в строке 'Заработная плата' считается динамически по выполненным, но не оплаченным сотруднику услугам.

При нажатии на кнопку 'Выплатить ЗП' открывается форма, в которую автоматически подставляется сумма выполненных, но не оплаченных услуг.
После подтверждения создаётся запись в таблице 'Платежи' с соответствующим расходом и основанием 'Выплата заработной платы', а статус услуг меняется на 'Оплачено'<br>

Кнопки 'Премия' и 'Штраф' позволяют премировать, либо оштрафовать сотрудника.

Кнопка 'Промежуточная выплата' позволяет выплатить сотруднику произвольную сумму без полной выплаты заработной платы.

При удалении записи с основанием 'Выплата ЗП', статус всех услуг, которые были выплачены мастеру этой операцией, меняется на 'не выплачены', пересчитывается сумма ЗП сотрудника, а также удаляется соответствующая запись в таблице 'Платежи'.

### <a id="search"></a> Поиск
На главной странице с таблицей всех заказов реализована функция поиска<br>
Поиск работает по следующим параметрам:

  - ФИО клиента
  - Номер телефона клиента
  - Тип устройства
  - Производитель устройства
  - Модель устройства
  - Неисправность устройства

### <a id="filter"></a> Фильтр
На главной странице с таблицей всех заказов и на странице платежей реализована функция фильтрации
Фильтр работает по следующим параметрам:

 - Дата (предустановленные варианты + указание диапазона). По умолчанию установлен вариант 'С начала месяца'
 - Сотрудник (выбирается из списка). 
